<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I2S Arbitor</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='16' cy='16' r='15' fill='%231a1a2e' stroke='%239b59b6' stroke-width='2'/%3E%3Ccircle cx='16' cy='16' r='4' fill='%239b59b6'/%3E%3Cpath d='M8 8l5 5M24 8l-5 5M8 24l5-5M24 24l-5-5' stroke='%239b59b6' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #0f3460;
            --accent: #9b59b6;
            --accent-hover: #b370cf;
            --accent-green: #4ecca3;
            --accent-red: #e94560;
            --accent-yellow: #ffd93d;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --border: #2a2a4a;
            --success: #4ecca3;
            --warning: #ffd93d;
            --error: #e94560;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 30px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--accent), var(--accent-hover));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .title h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .title p {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .health-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-secondary);
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .health-badge.healthy {
            color: var(--success);
        }

        .health-badge.offline {
            color: var(--error);
        }

        .health-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: var(--bg-card);
            color: var(--accent);
        }

        /* Status Overview */
        .status-overview {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary));
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .status-header h2 {
            font-size: 1.1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .active-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-primary);
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .active-indicator.has-active {
            color: var(--success);
        }

        .active-indicator.no-active {
            color: var(--text-secondary);
        }

        .btn-deactivate {
            padding: 10px 20px;
            border: none;
            background: var(--accent-red);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-deactivate:hover {
            background: #ff6b6b;
            transform: scale(1.02);
        }

        .btn-deactivate:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Services Grid */
        .services-section h2 {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .services-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        /* Service Card */
        .service-card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .service-card.active {
            border-color: var(--success);
            box-shadow: 0 0 20px rgba(78, 204, 163, 0.2);
        }

        .service-card.offline {
            opacity: 0.6;
        }

        .service-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .service-info h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .service-info .service-name {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-family: 'SF Mono', Monaco, monospace;
        }

        .service-status {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 6px;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-badge.online {
            background: rgba(78, 204, 163, 0.2);
            color: var(--success);
        }

        .status-badge.offline {
            background: rgba(233, 69, 96, 0.2);
            color: var(--error);
        }

        .status-badge.locked {
            background: rgba(255, 217, 61, 0.2);
            color: var(--warning);
        }

        .status-badge.active {
            background: rgba(78, 204, 163, 0.3);
            color: var(--success);
        }

        .service-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
            padding: 12px;
            background: var(--bg-primary);
            border-radius: 8px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .detail-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-value {
            font-size: 0.85rem;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .service-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-activate {
            background: var(--accent);
            color: white;
        }

        .btn-activate:hover {
            background: var(--accent-hover);
        }

        .btn-lock {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .btn-lock:hover {
            background: var(--accent-yellow);
            color: var(--bg-primary);
        }

        .btn-unlock {
            background: var(--accent-yellow);
            color: var(--bg-primary);
        }

        .btn-unlock:hover {
            background: #ffe566;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Activity Log */
        .activity-section {
            margin-top: 30px;
        }

        .activity-section h2 {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .activity-log {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .log-entry {
            display: flex;
            gap: 12px;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.85rem;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-time {
            color: var(--text-secondary);
            font-family: 'SF Mono', Monaco, monospace;
            flex-shrink: 0;
        }

        .log-message {
            flex: 1;
        }

        .log-entry.info .log-message {
            color: var(--accent);
        }

        .log-entry.success .log-message {
            color: var(--success);
        }

        .log-entry.warning .log-message {
            color: var(--warning);
        }

        .log-entry.error .log-message {
            color: var(--error);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 12px 20px;
            background: var(--bg-card);
            border-radius: 8px;
            border-left: 3px solid;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.success {
            border-left-color: var(--success);
        }

        .toast.error {
            border-left-color: var(--error);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* About Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 30px;
            max-width: 450px;
            width: 90%;
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-card);
            color: var(--text-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--accent-red);
            color: white;
        }

        .modal-content p {
            color: var(--text-secondary);
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .modal-credits {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .modal-credits h3 {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .modal-credits p {
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .header-left {
                flex-direction: column;
            }

            .status-header {
                flex-direction: column;
                gap: 15px;
            }

            .services-grid {
                grid-template-columns: 1fr;
            }

            .service-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="logo">
                    <i class="fas fa-network-wired"></i>
                </div>
                <div class="title">
                    <h1>I2S Arbitor</h1>
                    <p>Audio Service Controller</p>
                </div>
            </div>
            <div class="header-right">
                <div class="health-badge healthy" id="health-badge">
                    <span class="health-dot"></span>
                    <span>Healthy</span>
                </div>
                <button class="btn-icon" id="btn-about" title="About">
                    <i class="fas fa-info-circle"></i>
                </button>
            </div>
        </header>

        <!-- Status Overview -->
        <section class="status-overview">
            <div class="status-header">
                <h2>
                    <i class="fas fa-broadcast-tower"></i>
                    Active Output
                </h2>
                <div class="active-indicator no-active" id="active-indicator">
                    <i class="fas fa-circle"></i>
                    <span id="active-service-name">No Active Service</span>
                </div>
            </div>
            <button class="btn-deactivate" id="btn-deactivate-all" disabled>
                <i class="fas fa-stop-circle"></i>
                Deactivate All Services
            </button>
        </section>

        <!-- Services Section -->
        <section class="services-section">
            <h2>
                <i class="fas fa-layer-group"></i>
                Managed Services
            </h2>
            <div class="services-grid" id="services-grid">
                <!-- Services will be rendered here -->
            </div>
        </section>

        <!-- Activity Log -->
        <section class="activity-section">
            <h2>
                <i class="fas fa-list"></i>
                Activity Log
            </h2>
            <div class="activity-log" id="activity-log">
                <div class="log-entry info">
                    <span class="log-time">--:--:--</span>
                    <span class="log-message">Waiting for status...</span>
                </div>
            </div>
        </section>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- About Modal -->
    <div class="modal-overlay" id="about-modal">
        <div class="modal">
            <div class="modal-header">
                <h2>
                    <i class="fas fa-network-wired"></i>
                    I2S Arbitor
                </h2>
                <button class="modal-close" id="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-content">
                <p>
                    I2S Arbitor manages and coordinates multiple I2S audio services on your
                    Raspberry Pi. It ensures only one service outputs audio at a time,
                    preventing conflicts and providing centralized control.
                </p>
                <p>
                    Use this interface to monitor service status, activate/deactivate
                    services, and manage audio output priorities.
                </p>
                <div class="modal-credits">
                    <h3>Credits</h3>
                    <p>Developed by Rick McNeely</p>
                    <p>With assistance from Claude Code</p>
                    <p style="margin-top: 10px; color: var(--text-secondary); font-size: 0.85rem;">
                        Dedicated to Legacy Audio Inc.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api/v1';
        let activityLog = [];
        let lastStatus = null;

        // Utility Functions
        function formatTime(date) {
            return date.toTimeString().split(' ')[0];
        }

        function addLog(message, type = 'info') {
            const entry = {
                time: formatTime(new Date()),
                message: message,
                type: type
            };
            activityLog.unshift(entry);
            if (activityLog.length > 50) {
                activityLog.pop();
            }
            renderActivityLog();
        }

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.innerHTML = '<i class="fas fa-' + (type === 'success' ? 'check-circle' : 'exclamation-circle') + '"></i>' + message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Render Functions
        function renderActivityLog() {
            const container = document.getElementById('activity-log');
            if (activityLog.length === 0) {
                container.innerHTML = '<div class="log-entry info"><span class="log-time">--:--:--</span><span class="log-message">No activity yet</span></div>';
                return;
            }
            container.innerHTML = activityLog.map(entry =>
                '<div class="log-entry ' + entry.type + '">' +
                '<span class="log-time">' + entry.time + '</span>' +
                '<span class="log-message">' + entry.message + '</span>' +
                '</div>'
            ).join('');
        }

        function renderServices(services, activeService) {
            const grid = document.getElementById('services-grid');
            // Sort by priority to ensure consistent ordering
            services.sort((a, b) => a.priority - b.priority);
            grid.innerHTML = services.map(svc => {
                const isActive = svc.name === activeService && svc.active;
                const cardClass = 'service-card' + (isActive ? ' active' : '') + (!svc.online ? ' offline' : '');

                return '<div class="' + cardClass + '" data-service="' + svc.name + '">' +
                    '<div class="service-card-header">' +
                        '<div class="service-info">' +
                            '<h3>' + svc.display_name + '</h3>' +
                            '<span class="service-name">' + svc.name + '</span>' +
                        '</div>' +
                        '<div class="service-status">' +
                            '<span class="status-badge ' + (svc.online ? 'online' : 'offline') + '">' +
                                (svc.online ? 'Online' : 'Offline') +
                            '</span>' +
                            (svc.locked ? '<span class="status-badge locked">Locked</span>' : '') +
                            (svc.active ? '<span class="status-badge active">Active</span>' : '') +
                        '</div>' +
                    '</div>' +
                    '<div class="service-details">' +
                        '<div class="detail-item">' +
                            '<span class="detail-label">Priority</span>' +
                            '<span class="detail-value">' + svc.priority + '</span>' +
                        '</div>' +
                        '<div class="detail-item">' +
                            '<span class="detail-label">Last Check</span>' +
                            '<span class="detail-value">' + (svc.last_check ? new Date(svc.last_check).toLocaleTimeString() : '--') + '</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="service-actions">' +
                        '<button class="btn btn-activate" onclick="activateService(\'' + svc.name + '\')" ' +
                            ((!svc.online || isActive) ? 'disabled' : '') + '>' +
                            '<i class="fas fa-play"></i> Activate' +
                        '</button>' +
                        (svc.locked ?
                            '<button class="btn btn-unlock" onclick="unlockService(\'' + svc.name + '\')" ' +
                                (!svc.online ? 'disabled' : '') + '>' +
                                '<i class="fas fa-unlock"></i> Unlock' +
                            '</button>' :
                            '<button class="btn btn-lock" onclick="lockService(\'' + svc.name + '\')" ' +
                                (!svc.online ? 'disabled' : '') + '>' +
                                '<i class="fas fa-lock"></i> Lock' +
                            '</button>'
                        ) +
                    '</div>' +
                '</div>';
            }).join('');
        }

        function updateActiveIndicator(activeService, services) {
            const indicator = document.getElementById('active-indicator');
            const nameSpan = document.getElementById('active-service-name');
            const deactivateBtn = document.getElementById('btn-deactivate-all');

            if (activeService) {
                const svc = services.find(s => s.name === activeService);
                indicator.className = 'active-indicator has-active';
                nameSpan.textContent = svc ? svc.display_name : activeService;
                deactivateBtn.disabled = false;
            } else {
                indicator.className = 'active-indicator no-active';
                nameSpan.textContent = 'No Active Service';
                deactivateBtn.disabled = true;
            }
        }

        function updateHealth(isHealthy) {
            const badge = document.getElementById('health-badge');
            if (isHealthy) {
                badge.className = 'health-badge healthy';
                badge.innerHTML = '<span class="health-dot"></span><span>Healthy</span>';
            } else {
                badge.className = 'health-badge offline';
                badge.innerHTML = '<span class="health-dot"></span><span>Offline</span>';
            }
        }

        // API Functions
        async function loadStatus() {
            try {
                const response = await fetch(API_BASE + '/status');
                if (!response.ok) throw new Error('Failed to fetch status');

                const data = await response.json();
                updateHealth(true);

                // Detect changes for logging
                if (lastStatus) {
                    if (lastStatus.active_service !== data.active_service) {
                        if (data.active_service) {
                            addLog('Service activated: ' + data.active_service, 'success');
                        } else if (lastStatus.active_service) {
                            addLog('Service deactivated: ' + lastStatus.active_service, 'warning');
                        }
                    }

                    // Check for service state changes
                    data.services.forEach(svc => {
                        const prev = lastStatus.services.find(s => s.name === svc.name);
                        if (prev) {
                            if (prev.online !== svc.online) {
                                addLog(svc.display_name + ' is now ' + (svc.online ? 'online' : 'offline'),
                                    svc.online ? 'success' : 'error');
                            }
                            if (prev.locked !== svc.locked) {
                                addLog(svc.display_name + ' ' + (svc.locked ? 'locked' : 'unlocked'), 'info');
                            }
                        }
                    });
                } else {
                    addLog('Connected to I2S Arbitor', 'success');
                }

                lastStatus = data;
                renderServices(data.services, data.active_service);
                updateActiveIndicator(data.active_service, data.services);

            } catch (err) {
                updateHealth(false);
                console.error('Error loading status:', err);
            }
        }

        async function activateService(name) {
            try {
                const response = await fetch(API_BASE + '/services/' + name + '/activate', {
                    method: 'POST'
                });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to activate service');
                }

                showToast('Service activated: ' + name, 'success');
                loadStatus();
            } catch (err) {
                showToast(err.message, 'error');
                addLog('Failed to activate ' + name + ': ' + err.message, 'error');
            }
        }

        async function lockService(name) {
            try {
                const response = await fetch(API_BASE + '/services/' + name + '/lock', {
                    method: 'POST'
                });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to lock service');
                }

                showToast('Service locked: ' + name, 'success');
                loadStatus();
            } catch (err) {
                showToast(err.message, 'error');
                addLog('Failed to lock ' + name + ': ' + err.message, 'error');
            }
        }

        async function unlockService(name) {
            try {
                const response = await fetch(API_BASE + '/services/' + name + '/lock', {
                    method: 'DELETE'
                });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to unlock service');
                }

                showToast('Service unlocked: ' + name, 'success');
                loadStatus();
            } catch (err) {
                showToast(err.message, 'error');
                addLog('Failed to unlock ' + name + ': ' + err.message, 'error');
            }
        }

        async function deactivateAll() {
            try {
                const response = await fetch(API_BASE + '/deactivate-all', {
                    method: 'POST'
                });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to deactivate services');
                }

                showToast('All services deactivated', 'success');
                loadStatus();
            } catch (err) {
                showToast(err.message, 'error');
                addLog('Failed to deactivate all: ' + err.message, 'error');
            }
        }

        // Modal Functions
        function showModal() {
            document.getElementById('about-modal').classList.add('active');
        }

        function hideModal() {
            document.getElementById('about-modal').classList.remove('active');
        }

        // Event Listeners
        function init() {
            document.getElementById('btn-about').addEventListener('click', showModal);
            document.getElementById('modal-close').addEventListener('click', hideModal);
            document.getElementById('about-modal').addEventListener('click', function(e) {
                if (e.target === this) hideModal();
            });
            document.getElementById('btn-deactivate-all').addEventListener('click', deactivateAll);

            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') hideModal();
            });

            // Initial load and start polling
            loadStatus();
            setInterval(loadStatus, 2000);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
